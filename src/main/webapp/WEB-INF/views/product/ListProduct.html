<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>

    <title>Title</title>
    <th:block th:replace="/layout/head_1 :: head_1"/>
    <link rel="stylesheet" href="/assets/css/bootstrap.minb.css">
</head>
<body>

<div id="wrapper">
    <th:block th:replace="/layout/navbar_custom_top_2 :: navbar_custom_top_2"/>


    <div class="left-side-menu">

        <th:block th:replace="/layout/hearder_left_3 :: hearder_left_3"/>

    </div>


    <div class="content-page">

        <div class="content">
            <!-- Start Content-->
            <div class="container-fluid">
                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box">
                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item">Uplon</li>
                                    <li class="breadcrumb-item active">Dashboard</li>
                                </ol>
                            </div>
                            <h4 class="page-title">Welcome List Product</h4>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-10 d-none d-sm-block" style="margin-bottom: 20px">
                        <form class="form-inline">
                            <input class="form-control col-3 mr-sm-2" type="search" placeholder="Search" aria-label="Search" id="searchProduct" name="keyword">
                            <button class="btn btn-primary" id="btn-search-product" type="button"> <i class="fas fa-search"></i></button>
                        </form>
                    </div>
                </div>

                <div class="row">
                    <div class="col-10">
                        <h1>List of Product</h1>
                    </div>
                    <div class="col-2 create">
                            <button type="button" class="btn btn-success create-modal">Create Product</button>
                    </div>
                    <div id="divFail">
                        <div></div>
                    </div>

                    <table id="tbListProducts" class="table table-hover table-bordered" style="text-align: center">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Id</th>
                                <th>Avatar</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Describe</th>
                                <th>TitleCategory</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>



    <th:block th:replace="/layout/script_6 :: script_6"/>

</div>

<div class="footer" style="position: fixed; right: 0; bottom: 0">


</div>

<th:block th:replace="/product/footer :: footer"/>

<th:block th:replace="/product/modal_create :: modal_create"/>
<th:block th:replace="/product/modal_update :: modal_update"/>
<th:block th:replace="/product/modal_detail :: modal_detail"/>
<script>

    let product = new Product();
    let category = new Category();

    let productId = null;

    $('.create-modal').on('click', function (){
        $('#modalCreateProduct').modal('show')

        /*Mở ra addClass'hide' để ẩn các lỗi nếu dữ liệu vào fail*/
        $('#modalCreateProduct .modal-alert-danger').html('').removeClass('show').addClass('hide');

        /*Khi mở ra clear lại dữ liệu hết*/
        clearInput();
    })

    //Hiển thị thông báo có muốn thoát không
    $('#logout').on('click', function (){
        let confim = confirm("Bạn có chắc muốn thoát ứng dụng không!")
        if(confim === true){

            App.SweetAlert.showSuccessAlert("Đăng Xuất Thành Công")
            setTimeout(function () {
                window.location.href = "/"
            }, 3000);
        }
    })

    /*Khi click vào hiển thị thanh edit và delete*/
    function handleShowFooter() {
        $('#tbListProducts tbody tr').on('click', function () {
            /*Trỏ theo id của từng thằng để lấy ra thông tin update*/
            let id = $(this).attr("id")

            /*Trỏ theo id của từng thằng để lấy ra thông tin update*/
            productId = id.replace("tr_", "");

            console.log(productId);
            $("#tbListProducts tbody tr td span").removeClass("selected").addClass("unselected");
            $(`#${id} span`).removeClass("unselected").addClass("selected");

            let temFooter = $.validator.format($.trim($('#tempFooter').val().toString()))
            $('.footer').html(temFooter)

            handleShowUpdate();

            handleShowDetail();

            handleConfirmDelete();

        })
    }

    function getAllProduct(){
        $.ajax({
            header: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "GET",
            url: "http://localhost:8080/api/products",
        })
            .done((data) => {
                $.each(data ,(i, item)=>{
                    product = item;
                    category = product.category;

                    let str =`
                     <tr id="tr_${product.id}">
                            <td><span id="span_${product.id}" class="select-tab unselected"></td>
                            <td>${product.id}</td>
                            <td><img src="${product.urlImage}" alt="" style="width: 90px; height:70px ; border-radius:50%"> </td>
                            <td>${product.name}</td>
                            <td>${new Intl.NumberFormat('vi-VN', {
                                        style: 'currency',
                                        currency: 'VND'
                            }).format(product.price)}</td>
                            <td>${product.describe}</td>
                            <td>${category.title}</td>
                     </tr>
                `;
                    $('#tbListProducts tbody').prepend(str);

                    handleShowFooter();
                })
            })
            .fail((jqXHR) => {
                console.log(jqXHR)
            })
    }
    getAllProduct();



    let btnCreateProduct = $('#btnCreateProduct');
    btnCreateProduct.on('click', function (){

        product.name = $('#username').val();
        product.urlImage = $('#urlImage').val();
        product.price = $('#price').val();
        product.describe = $('#describe').val();

        category.id = $('#category').val();
        category.title = $('#category :selected').text()

        product.category = category;
        $.ajax({
            "headers": {
                "accept": "application/json",
                "content-type": "application/json"
            },
            "type": "POST",
            "url": "http://localhost:8080/api/products/create",
            "data": JSON.stringify(product)
        })
            .done((data) => {
                console.log(data)
                product = data;
                category = product.category;

                let str =`
                 <tr id="tr_${product.id}">
                        <td><span id="span_${product.id}" class="select-tab unselected"></td>
                        <td>${product.id}</td>
                        <td><img src="${product.urlImage}" alt="" style="width: 90px; height:70px ; border-radius:50%"> </td>
                        <td>${product.name}</td>
                        <td>${new Intl.NumberFormat('vi-VN', {
                            style: 'currency',
                            currency: 'VND'
                        }).format(product.price)}</td>

                        <td>${product.describe}</td>
                        <td>${category.title}</td>
                 </tr>
                `;
                $('#tbListProducts tbody').prepend(str);

                App.SweetAlert.showSuccessAlert("Tạo Mới Thành Công")

                $('#modalCreateProduct').modal('hide')

                clearInput()

                handleShowFooter();
            })

            .fail((jqXHR) => {
                console.log(jqXHR)

                $('#modalCreateProduct .modal-alert-danger').html('').removeClass('hide').addClass('show');

                if (jqXHR.status === 401) {
                    let msg = "Vui lòng đăng nhập !!";

                    let str = `<label id="message-error" class="error" for="message">${msg}</label>`;

                    $('#modalCreateProduct .modal-alert-danger').append(str);
                }
                //Nếu lỗi 403 thì chuyển qua trang lỗi
                if (jqXHR.status === 403) {
                    window.location.href = "/select/403"
                }


                if (jqXHR.responseJSON.message) {

                    let msg = jqXHR.responseJSON.message;

                    let str = `<label id="message-error" class="error" for="message"> ${msg} </label>`;

                    $('#modalCreateProduct .modal-alert-danger').append(str);


                }else if (jqXHR.responseJSON) {
                    $.each(jqXHR.responseJSON, (key, item) => {
                        let str = `<label id="${key}-error" class="error" for="${key}"> ${item} </label>`;

                        $('#modalCreateProduct .modal-alert-danger').append(str);
                    })
                }

            })
    })


    /*Clear mới tất cả khi thêm mới*/
    function clearInput(){
        $("#frmCreateProduct input").val("");
    }

    //Hiển thị dữ liệu của Id ra, phai viet ham tim Id o rest CustomerController
    function handleShowUpdate() {
        $('button.edit').on('click', function () {
            console.log(productId)
            $.ajax({
                "headers": {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                "type": "GET",
                "url": "http://localhost:8080/api/products/" + productId,
            })
            .done((data)=>{
                product = data;
                category = product.category;

                $('#usernameUp').val(product.name);
                $('#urlImageUp').val(product.urlImage);
                $('#priceUp').val(product.price);
                $('#describeUp').val(product.describe);

                //Chỉ cần lấy theo id thì Nó sẽ tự hiển thị tên giày ra
                $('#categoryUp').val(category.id);

                $('#modalUpdateProduct').modal('show');

                $('#modalUpdateProduct .modal-alert-danger').html('').removeClass('show').addClass('hide');
            })
        })
    }

    let btnUpdateProduct = $('#btnUpdateProduct')
    $('#btnUpdateProduct').on('click', function (){
        product.name = $('#usernameUp').val();
        product.urlImage = $('#urlImageUp').val();
        product.price = $('#priceUp').val();
        product.describe = $('#describeUp').val();

        category.id = $('#categoryUp').val();
        category.title = $('#categoryUp :selected').text()

        product.category = category;
        $.ajax({
            "headers": {
                "accept": "application/json",
                "content-type": "application/json"
            },
            "type": "PUT",
            "url": "http://localhost:8080/api/products/update",
            "data": JSON.stringify(product)
        })
        .done((data) => {
            console.log(data)
            product = data;
            category = product.category;

            let currentRow = $('#tr_'+ productId);

            let str =`
                 <tr id="tr_${product.id}">
                        <td><span id="span_${product.id}" class="select-tab unselected"></td>
                        <td>${product.id}</td>
                        <td><img src="${product.urlImage}" alt="" style="width: 90px; height:70px ; border-radius:50%"> </td>
                        <td>${product.name}</td>
                        <td>${new Intl.NumberFormat('vi-VN', {
                                style: 'currency',
                                currency: 'VND'
                            }).format(product.price)}</td>

                        <td>${product.describe}</td>
                        <td>${category.title}</td>
                 </tr>
                `;

            currentRow.replaceWith(str)

            App.SweetAlert.showSuccessAlert("Cập Nhật Thành Công")
            $('#modalUpdateProduct').modal('hide');

            handleShowFooter();

        })
        .fail((jqXHR) =>{
            console.log(jqXHR)
            $('#modalUpdateProduct .modal-alert-danger').html('').removeClass('hide').addClass('show');
            if (jqXHR.status === 401) {
                let msg = "Vui lòng đăng nhập !!";
                let str = `<label id="message-error" class="error" for="message">${msg}</label>`;

                $('#modalUpdateProduct .modal-alert-danger').append(str);
            }
            //Nếu lỗi 403 thì chuyển qua trang lỗi
            if (jqXHR.status === 403) {
                    window.location.href = "/select/403"
            }

            if (jqXHR.responseJSON.message) {

                let msg = jqXHR.responseJSON.message;

                let str = `<label id="message-error" class="error" for="message">${msg}</label>`;

                $('#modalUpdateProduct .modal-alert-danger').append(str);

            }else if (jqXHR.responseJSON) {
                $.each(jqXHR.responseJSON, (key, item) => {
                    let str = `<label id="${key}-error" class="error" for="${key}"> ${item} </label>`;

                    $('#modalUpdateProduct .modal-alert-danger').append(str);
                })
            }
        })
    })

    function handleShowDetail() {
        $('button.detail').on('click', function () {
            $.ajax({
                header: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "GET",
                url: "http://localhost:8080/api/products/" + productId,
            })
                .done((data) => {
                    $('#urlImageDet').html("");
                    product = data;
                    category = product.category;

                    $('#nameDet').text(product.name)

                    $('#priceDet').text(`${new Intl.NumberFormat('vi-VN', {
                        style: 'currency',
                        currency: 'VND'
                    }).format(product.price)}`)

                    $('#describeDet').text(product.describe)
                    $('#categoryDet').text(product.category.title)

                    $('#createdAtDet').text(product.createdAt)

                    $('#updatedAtDet').text(product.updatedAt)

                    let str =`
                    <img style="width: 255px;" src="${product.urlImage}" alt="">
                 `;

                    $('#urlImageDet').prepend(str);

                    $('#modalDetail').modal('show')
                })

        })
    }


    $('#btn-search-product').on('click', function (){
        let keyword = $('#searchProduct').val();
        search(keyword);
    })

    function search(keyword) {
        $.ajax({
            header: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "GET",
            url: "http://localhost:8080/api/products/search/" + keyword,
        })
            .done((data) => {

                $('#tbListProducts tbody').html('')

                $.each(data, (i, item) => {
                    product = item;
                    category = product.category;

                    let str =`
                     <tr id="tr_${product.id}">
                            <td><span id="span_${product.id}" class="select-tab unselected"></td>
                            <td>${product.id}</td>
                            <td><img src="${product.urlImage}" alt="" style="width: 90px; height:70px ; border-radius:50%"> </td>
                            <td>${product.name}</td>
                            <td>${new Intl.NumberFormat('vi-VN', {
                                style: 'currency',
                                currency: 'VND'
                            }).format(product.price)}</td>

                            <td>${product.describe}</td>
                            <td>${category.title}</td>
                     </tr>
                `;
                    $('#tbListProducts tbody').prepend(str);


                    handleShowFooter();
                })
            })

            .fail((jqXHR) => {
                console.log(jqXHR)
                // $('#divFail div').html('');
                //
                // let str =`<h3>Không có kết quả tìm kiếm này!</h3>`
                // $('#divFail div').prepend(str);
            })
    }


    /*Hàm xóa mềm theo id,*/
    function handleConfirmDelete() {
        $('button.deleted').on('click', function () {
            App.SweetAlert.showConfirmDelete()
                .then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            "headers": {
                                "accept": "application/json",
                                "content-type": "application/json"
                            },
                            "type": "DELETE",
                            "url": "http://localhost:8080/api/products/delete/" + productId,
                            "data": JSON.stringify(product)
                        })
                        .done((data) => {
                            $('#tr_' + productId).remove();
                            App.SweetAlert.showSuccessAlert("Xóa Thành Công")

                        })
                        .fail((jqXHR) => {

                            //Nếu lỗi 403 thì chuyển qua trang lỗi
                            if (jqXHR.status === 403) {
                                window.location.href = "/select/403"
                            }

                            App.SweetAlert.showErrorAlert('Xóa thất bại');


                        });

                    }
                })
        })
    }









</script>

</body>

</html>